
‚∏ª

üìÑ SQL BOT USING CLOUD FUNCTION (GEN2) ‚Äì PROJECT NOTES

‚∏ª

1. Project Overview

This project focuses on building a SQL Chatbot for BigQuery using:
	‚Ä¢	Cloud Function (Gen2)
	‚Ä¢	Gemini API (via Vertex AI REST API)
	‚Ä¢	BigQuery Client
	‚Ä¢	HTTP Trigger
	‚Ä¢	Python FastAPI backend

The bot receives natural language queries and returns:
	‚Ä¢	SQL Query generated by Gemini
	‚Ä¢	BigQuery execution result
	‚Ä¢	JSON response

The project works even in Free trial (no Vertex AI Agents, no agent garden required).

‚∏ª

2. High-Level Architecture (HLD)

User ‚Üí Cloud Function HTTP Endpoint ‚Üí FastAPI App
      ‚Üí Gemini Model (Generate SQL)
      ‚Üí BigQuery Query Execution
      ‚Üí JSON Response returned to user


‚∏ª

3. Low-Level Architecture (LLD)

Components
	‚Ä¢	main.py
	‚Ä¢	requirements.txt
	‚Ä¢	Cloud Function Gen2
	‚Ä¢	Artifact Registry (only for Gen2)
	‚Ä¢	Service Account (BigQuery + VertexAI permissions)
	‚Ä¢	Environment Variables (API Key or ADC)

Execution Flow

HTTP Request ‚Üí validate ‚Üí call Gemini ‚Üí generate SQL
      ‚Üì
Run SQL on BigQuery
      ‚Üì
Return JSON result


‚∏ª

4. Final Working main.py (FastAPI)

from fastapi import FastAPI, Request
from google.cloud import bigquery
import requests
import os

app = FastAPI()

PROJECT_ID = os.environ.get("PROJECT_ID")
LOCATION = "us-central1"
MODEL = "gemini-1.5-flash-001"

client = bigquery.Client()

@app.get("/")
def index():
    return {"status": "SQL Bot Running on Cloud Function Gen2"}

@app.post("/query")
async def run_query(req: Request):
    body = await req.json()
    question = body.get("question", "")

    prompt = f"Convert this into BigQuery SQL for table sales_data(name, amount, purchase_date): {question}"

    url = f"https://{LOCATION}-aiplatform.googleapis.com/v1/projects/{PROJECT_ID}/locations/{LOCATION}/publishers/google/models/{MODEL}:generateContent"

    headers = {
        "Content-Type": "application/json",
        "Authorization": f"Bearer {os.environ.get('API_KEY')}"
    }

    payload = {
        "contents": [{"role": "user", "parts": [{"text": prompt}]}]
    }

    response = requests.post(url, json=payload, headers=headers)
    sql = response.json()["candidates"][0]["content"]["parts"][0]["text"]

    query_job = client.query(sql)
    rows = [dict(row) for row in query_job]

    return {
        "natural_question": question,
        "generated_sql": sql,
        "result": rows
    }


‚∏ª

5. requirements.txt

fastapi
uvicorn
google-cloud-bigquery
requests
google-auth


‚∏ª

6. gcloud Deployment Commands

Enable Gen2

gcloud services enable run.googleapis.com
gcloud services enable artifactregistry.googleapis.com
gcloud services enable cloudfunctions.googleapis.com

Deploy

gcloud functions deploy sql-bot \
  --gen2 \
  --runtime=python311 \
  --region=us-central1 \
  --entry-point=app \
  --source=. \
  --trigger-http \
  --allow-unauthenticated \
  --set-env-vars=PROJECT_ID=your_project_id,API_KEY=your_api_key


‚∏ª

7. All Challenges Faced & Fixes

‚ùå Challenge 1: Cloud Function Gen2 showing error

Error:

user-provided container failed to start OR health check failed

Cause:
FastAPI not listening on correct PORT.

Fix:
Cloud Run uses PORT env variable.
We added:

uvicorn.run(app, host="0.0.0.0", port=int(os.environ["PORT"]))


‚∏ª

‚ùå Challenge 2: Artifact Registry Errors

Error:

Error while performing action in artifact registry

Fix:
Enabled API:

gcloud services enable artifactregistry.googleapis.com


‚∏ª

‚ùå Challenge 3: Health check failed ‚Äì PORT = 8089

Cloud Run enforces single PORT defined by the environment.

Fix:
Never hardcode ports.
Always use:

PORT = os.environ.get("PORT", 8080)


‚∏ª

‚ùå Challenge 4: Missing Runtime Container

Gen2 requires Dockerfile or buildpack.
We used GCP buildpack default, so no Dockerfile required.

‚∏ª

‚ùå Challenge 5: ModuleNotFoundError

Because incorrect folder structure.

Fix:
Your files must be:

/main.py
/requirements.txt


‚∏ª

‚ùå Challenge 6: Gemini API Permission Denied

Because free trial has restricted Vertex.

Fix:
Use REST API with API Key, not service account.

‚∏ª

‚ùå Challenge 7: BigQuery Permission Errors

Added service account role:

roles/bigquery.dataViewer
roles/bigquery.jobUser


‚∏ª

8. How to Test

Local

uvicorn main:app --reload --port 8080

POST Body:

{
  "question": "Show total sales last 7 days"
}

Cloud Function URL Example

POST https://us-central1-your-project.cloudfunctions.net/sql-bot/query


‚∏ª

9. Final Lessons Learned
	‚Ä¢	Cloud Function Gen2 requires correct port handling.
	‚Ä¢	Artifact Registry must be enabled even without Dockerfile.
	‚Ä¢	Gemini API works with API Key + REST API in free trial.
	‚Ä¢	FastAPI must expose HTTP endpoints correctly.
	‚Ä¢	BigQuery requires correct IAM roles.
	‚Ä¢	Health checks fail if container does not start within 4 minutes.

‚∏ª

END OF NOTEPAD FILE

‚∏ª
